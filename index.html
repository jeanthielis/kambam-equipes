<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Equipes - Supervisor Pro</title>
    <style>
        :root {
            /* Vari√°veis Padr√£o (Light Mode) */
            --bg-color: #f4f5f7;
            --header-bg: #2c3e50;
            --text-color: #172b4d;
            
            --column-bg: #ebecf0;
            --card-bg: #ffffff;
            --card-border: #ccc;
            
            --input-bg: #fff;
            --input-border: #dfe1e6;
            --input-text: #172b4d;
            
            --stats-bg: #ffffff;
            --stats-border: #ddd;
            --badge-bg: #f0f2f5;
            --badge-text: #333;

            /* Cores funcionais (fixas) */
            --danger-color: #cf513d;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --info-color: #8e44ad;
            --edit-color: #f39c12;
        }

        /* --- DARK MODE OVERRIDES --- */
        body.dark-mode {
            --bg-color: #121212;
            --header-bg: #1a1a1a; /* Header um pouco mais escuro */
            --text-color: #e0e0e0;

            --column-bg: #1e1e1e; /* Colunas cinza escuro */
            --card-bg: #2d2d2d;   /* Cart√µes um pouco mais claros que a coluna */
            --card-border: #444;

            --input-bg: #333;
            --input-border: #555;
            --input-text: #fff;

            --stats-bg: #1e1e1e;
            --stats-border: #333;
            --badge-bg: #333;
            --badge-text: #eee;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- HEADER --- */
        header {
            background-color: var(--header-bg);
            color: white;
            padding: 10px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }

        .header-history {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            display: flex; align-items: center; gap: 15px;
            font-size: 0.9rem;
        }
        /* Ajuste inputs no header (datas) para ficarem vis√≠veis no dark mode */
        body.dark-mode .header-history input {
            background: #333; color: white; border: 1px solid #555;
        }

        h1 { margin: 0; font-size: 1.3rem; font-weight: 600; }

        button {
            padding: 6px 12px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: 600; font-size: 0.85rem;
            transition: all 0.2s;
        }
        button:hover { filter: brightness(110%); }

        .btn-primary { background-color: #0052cc; color: white; }
        .btn-secondary { background-color: #dfe1e6; color: #172b4d; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-print { background-color: #34495e; color: white; border: 1px solid #7f8c8d; }
        .btn-dark-toggle { background-color: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 1.1rem; padding: 2px 8px; }

        /* --- DASHBOARD DE ESTAT√çSTICAS --- */
        #dashboard-stats {
            background: var(--stats-bg);
            border-bottom: 1px solid var(--stats-border);
            padding: 10px 20px;
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
            font-size: 0.85rem;
            box-shadow: 0 2px 3px rgba(0,0,0,0.05);
            color: var(--text-color);
        }

        .stat-badge {
            display: inline-flex; align-items: center; padding: 4px 8px;
            border-radius: 4px; 
            background: var(--badge-bg); 
            color: var(--badge-text);
            font-weight: 600; border: 1px solid var(--stats-border);
        }
        .stat-badge.total { background: #2c3e50; color: white; border: 1px solid #2c3e50; font-size: 0.9rem; }
        
        .stat-divider { width: 1px; height: 20px; background: #ccc; margin: 0 5px; opacity: 0.5; }
        .stat-group-label { font-size: 0.75rem; text-transform: uppercase; opacity: 0.7; margin-right: 5px; font-weight: 700; }

        /* --- BOARD --- */
        #board {
            flex: 1; display: flex; overflow-x: auto; padding: 20px; gap: 15px; align-items: flex-start;
            scrollbar-width: thin; scrollbar-color: #888 transparent;
        }
        #board::-webkit-scrollbar { height: 12px; }
        #board::-webkit-scrollbar-track { background: transparent; }
        #board::-webkit-scrollbar-thumb { background-color: #888; border-radius: 20px; border: 3px solid transparent; background-clip: content-box; }

        #historyBanner {
            display: none; background: #ffab00; color: #172b4d;
            text-align: center; padding: 8px; font-weight: bold; border-bottom: 1px solid #dfe1e6;
        }

        /* Colunas */
        .column {
            background-color: var(--column-bg);
            min-width: 280px; width: 280px;
            border-radius: 8px; padding: 10px;
            display: flex; flex-direction: column;
            max-height: 100%;
            border-top: 4px solid transparent; 
            transition: background-color 0.3s;
        }

        .column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 4px; }

        .column-title {
            font-weight: 700; cursor: text; padding: 4px;
            border-radius: 4px; border: 2px solid transparent;
            background: transparent; width: 150px;
            color: var(--text-color);
        }
        .column-title:focus { background: var(--input-bg); border-color: #0052cc; outline: none; }

        .team-count {
            background: rgba(128,128,128,0.3); border-radius: 12px;
            padding: 2px 8px; font-size: 0.75rem; margin-left: 5px;
            color: var(--text-color);
        }

        .member-list {
            flex: 1; overflow-y: auto; min-height: 50px; padding-right: 4px;
            scrollbar-width: thin;
        }

        /* Cart√£o (Membro) */
        .card {
            background-color: var(--card-bg);
            border-radius: 6px; padding: 10px; margin-bottom: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            cursor: grab; position: relative;
            border-left: 5px solid #ccc;
            transition: background-color 0.3s;
            color: var(--text-color);
        }
        .card:active { cursor: grabbing; transform: rotate(1deg); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .card-name { font-weight: 600; font-size: 0.95rem; margin: 0; }
        
        .card-actions { display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s; }
        .card:hover .card-actions { opacity: 1; }

        .action-btn { background: none; border: none; padding: 2px; cursor: pointer; font-size: 1rem; color: #888; }
        .action-btn:hover.edit { color: var(--edit-color); }
        .action-btn:hover.del { color: var(--danger-color); }

        .role-badge {
            display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;
            color: white; font-weight: 700; text-transform: uppercase; margin-bottom: 5px;
        }

        .area-badge {
            display: block; font-size: 0.75rem; 
            color: var(--text-color); opacity: 0.8;
            background: rgba(0,0,0,0.05); 
            padding: 4px; border-radius: 4px; margin-top: 4px; 
            border: 1px solid var(--card-border);
        }
        body.dark-mode .area-badge { background: rgba(255,255,255,0.05); border-color: #444; }

        .dragging { opacity: 0.5; }
        .drag-over { background-color: rgba(0, 82, 204, 0.1); border: 2px dashed #0052cc; }
        
        .readonly-mode #board { opacity: 0.9; }
        .readonly-mode .card-actions, .readonly-mode .add-btn-container, .readonly-mode .col-del-btn { display: none !important; }
        .readonly-mode .column-title { pointer-events: none; }

        /* --- BOT√ÉO FLUTUANTE DE FOCO --- */
        #focus-toggle-btn {
            position: fixed; bottom: 25px; right: 25px;
            width: 55px; height: 55px; border-radius: 50%;
            background-color: var(--header-bg); color: white;
            font-size: 1.5rem; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            cursor: pointer; z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        #focus-toggle-btn:hover { transform: scale(1.1); }
        body.focus-active header, body.focus-active #dashboard-stats, body.focus-active #historyBanner { display: none !important; }

        /* --- MODAL --- */
        .modal {
            display: none; position: fixed; z-index: 2100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--input-bg); /* Adapta ao tema */
            color: var(--text-color);
            padding: 24px; border-radius: 8px; width: 400px; max-width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; opacity: 0.9; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px 10px; 
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--input-text);
            border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; margin-top: 20px; }
        .role-list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--input-border); }

        /* --- AREA DE IMPRESS√ÉO --- */
        #print-area { display: none; }
        @media print {
            /* For√ßa modo claro na impress√£o */
            body.dark-mode { --bg-color: #fff; --text-color: #000; }
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; background: white; color: black; padding: 20px; }
            .print-header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
            .print-stats { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; display: flex; gap: 15px; flex-wrap: wrap; }
            .print-team { margin-bottom: 25px; page-break-inside: avoid; }
            .print-team h3 { background: #eee; padding: 5px; margin: 0 0 10px 0; border-bottom: 1px solid #999; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
            th { background-color: #f0f0f0; }
        }

    </style>
</head>
<body>

<header>
    <div class="header-top">
        <h1>Gest√£o de Turno</h1>
        <div style="display:flex; gap:8px;">
            <button class="btn-dark-toggle" id="theme-btn" onclick="toggleTheme()" title="Alternar Tema">üåô</button>
            <div style="width:1px; background:#ffffff55; margin:0 5px;"></div>
            <button class="btn-print" onclick="generateAndPrint()">üñ®Ô∏è PDF</button>
            <div style="width:1px; background:#ffffff55; margin:0 5px;"></div>
            <button class="btn-info" onclick="downloadBackup()">‚¨á Backup</button>
            <button class="btn-info" onclick="document.getElementById('restoreInput').click()">‚¨Ü Restaurar</button>
            <input type="file" id="restoreInput" hidden accept=".json" onchange="restoreBackup(this)">
            <div style="width:1px; background:#ffffff55; margin:0 5px;"></div>
            <button class="btn-secondary" onclick="openRoleModal()">‚öôÔ∏è Cargos</button>
            <button class="btn-primary" onclick="addTeam()">+ Equipe</button>
        </div>
    </div>
    
    <div class="header-history">
        <span>üìÖ <strong>Hist√≥rico / Fechamento:</strong></span>
        <input type="month" id="monthPicker" onchange="checkHistory()">
        <button class="btn-warning" id="btnSaveHistory" onclick="saveHistorySnapshot()">Salvar Posi√ß√µes Atuais</button>
        <button class="btn-primary" id="btnBackToLive" style="display:none;" onclick="loadCurrentLive()">üîô Voltar ao Atual</button>
    </div>
</header>

<div id="dashboard-stats"></div>

<button id="focus-toggle-btn" onclick="toggleFocusMode()" title="Alternar Modo Tela Cheia / Foco">
    ‚õ∂
</button>

<div id="historyBanner"></div>

<div id="board"></div>

<div id="print-area"></div>

<div id="memberModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Novo Colaborador</h3>
        <input type="hidden" id="memId">
        <input type="hidden" id="memTeamId">
        <div class="form-group">
            <label>Nome:</label>
            <input type="text" id="memName" placeholder="Nome completo">
        </div>
        <div class="form-group">
            <label>Cargo / Fun√ß√£o:</label>
            <select id="memRoleSelect"></select>
        </div>
        <div class="form-group">
            <label>√Årea / M√°quina:</label>
            <select id="memAreaSelect">
                <option value="" disabled selected>Selecione...</option>
            </select>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('memberModal')">Cancelar</button>
            <button class="btn-success" onclick="saveMember()">Salvar</button>
        </div>
    </div>
</div>

<div id="roleModal" class="modal">
    <div class="modal-content">
        <h3>Gerenciar Cargos</h3>
        <div style="background: rgba(0,0,0,0.05); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
            <div class="form-group">
                <label>Nome do Cargo:</label>
                <input type="text" id="newRoleName" placeholder="Ex: Operador I">
            </div>
            <div class="form-group">
                <label>Cor:</label>
                <input type="color" id="newRoleColor" value="#0052cc" style="height:40px; padding:2px;">
            </div>
            <button class="btn-success" style="width:100%" onclick="addNewRole()">Adicionar</button>
        </div>
        <div id="rolesListContainer"></div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeModal('roleModal')">Fechar</button>
        </div>
    </div>
</div>

<script>
    // --- √ÅREAS FIXAS ---
    const FIXED_AREAS = ["Controle do Produto", "Qualitron L4", "Qualitron L5", "Qualitron 6A", "Qualitron 6B", "Inspe√ß√£o", "Outros / volante"];

    // --- ESTADO INICIAL ---
    const defaultData = {
        teams: [{ id: 't1', title: 'Equipe Alpha', members: [] }, { id: 't2', title: 'Equipe Bravo', members: [] }],
        roles: [{ id: 'r1', name: 'L√≠der', color: '#e74c3c' }, { id: 'r2', name: 'Operador', color: '#3498db' }]
    };

    let liveData = JSON.parse(localStorage.getItem('teamDataV9')) || defaultData;
    let historyData = JSON.parse(localStorage.getItem('teamHistoryV9')) || {};
    let isViewingHistory = false;
    let currentData = liveData;
    let draggedItem = null;

    // --- INICIALIZA√á√ÉO ---
    // 1. Carregar √Åreas
    const areaSelect = document.getElementById('memAreaSelect');
    FIXED_AREAS.forEach(area => {
        const opt = document.createElement('option'); opt.value = area; opt.innerText = area; areaSelect.appendChild(opt);
    });

    // 2. Inicializar Tema (Dark/Light)
    initTheme();

    // 3. Renderizar Board
    renderBoard(liveData);

    // --- L√ìGICA DE TEMA (DARK MODE) ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const btn = document.getElementById('theme-btn');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            btn.innerText = '‚òÄ'; // Mostra Sol para voltar ao claro
        } else {
            btn.innerText = 'üåô'; // Mostra Lua para ir ao escuro
        }
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-btn').innerText = isDark ? '‚òÄ' : 'üåô';
    }

    // --- FOCO (TELA CHEIA) ---
    function toggleFocusMode() {
        document.body.classList.toggle('focus-active');
        const btn = document.getElementById('focus-toggle-btn');
        if(document.body.classList.contains('focus-active')){
            btn.innerText = "‚úñ"; btn.style.backgroundColor = "#e74c3c";
        } else {
            btn.innerText = "‚õ∂"; btn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--header-bg');
        }
    }

    // --- RENDERIZA√á√ÉO ---
    function renderBoard(dataToRender) {
        currentData = dataToRender;
        updateDashboard(dataToRender);

        const board = document.getElementById('board');
        board.innerHTML = '';

        if (!dataToRender.teams) return;

        dataToRender.teams.forEach(team => {
            const column = document.createElement('div');
            column.className = 'column';
            column.dataset.id = team.id;
            column.innerHTML = `
                <div class="column-header">
                    <div style="display:flex; align-items:center;">
                        <input class="column-title" value="${team.title}" ${isViewingHistory ? 'disabled' : ''} onchange="updateTeamTitle(this, '${team.id}')">
                        <span class="team-count">${team.members.length}</span>
                    </div>
                    <button class="btn-danger col-del-btn" style="padding:2px 6px; font-size:0.7rem;" onclick="deleteTeam('${team.id}')">X</button>
                </div>
                <div class="member-list" id="${team.id}" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)"></div>
                <div class="add-btn-container">
                    <button class="btn-secondary" style="width:100%; margin-top:8px;" onclick="openMemberModal('${team.id}')">+ Adicionar</button>
                </div>
            `;
            const list = column.querySelector('.member-list');
            team.members.forEach(member => {
                const roleObj = dataToRender.roles.find(r => r.id === member.roleId) || { name: '?', color: '#ccc' };
                const memberArea = member.area || 'N√£o Definido';
                const card = document.createElement('div');
                card.className = 'card';
                card.id = member.id;
                card.draggable = !isViewingHistory;
                card.style.borderLeftColor = roleObj.color;
                card.innerHTML = `
                    <div class="card-header"><p class="card-name">${member.name}</p>
                        <div class="card-actions">
                            <button class="action-btn edit" onclick="editMember('${team.id}', '${member.id}')">‚úé</button>
                            <button class="action-btn del" onclick="deleteMember('${team.id}', '${member.id}')">‚úñ</button>
                        </div>
                    </div>
                    <span class="role-badge" style="background-color: ${roleObj.color}">${roleObj.name}</span>
                    <span class="area-badge">üìç ${memberArea}</span>
                `;
                if (!isViewingHistory) { card.addEventListener('dragstart', dragStart); card.addEventListener('dragend', dragEnd); }
                list.appendChild(card);
            });
            board.appendChild(column);
        });
    }

    // --- DASHBOARD ---
    function updateDashboard(data) {
        const container = document.getElementById('dashboard-stats');
        let total = 0; let roleCounts = {}; let areaCounts = {};
        data.teams.forEach(t => {
            total += t.members.length;
            t.members.forEach(m => {
                if(m.roleId) roleCounts[m.roleId] = (roleCounts[m.roleId] || 0) + 1;
                if(m.area) areaCounts[m.area] = (areaCounts[m.area] || 0) + 1;
            });
        });
        let html = `<span class="stat-badge total">Total: ${total}</span> <div class="stat-divider"></div>`;
        html += `<span class="stat-group-label">Cargos:</span>`;
        data.roles.forEach(r => {
            const count = roleCounts[r.id] || 0;
            if(count > 0) html += `<span class="stat-badge" style="border-left: 3px solid ${r.color}; margin-right:5px;">${r.name}: ${count}</span>`;
        });
        html += `<div class="stat-divider"></div> <span class="stat-group-label">M√°quinas:</span>`;
        Object.keys(areaCounts).sort().forEach(area => {
            html += `<span class="stat-badge" style="margin-right:5px;">üìç ${area}: ${areaCounts[area]}</span>`;
        });
        container.innerHTML = html;
    }

    // --- IMPRESS√ÉO ---
    function generateAndPrint() {
        const printArea = document.getElementById('print-area');
        const now = new Date();
        const viewMode = isViewingHistory ? `HIST√ìRICO: ${document.getElementById('monthPicker').value}` : "POSI√á√ÉO ATUAL";
        const statsHTML = document.getElementById('dashboard-stats').innerHTML;
        let html = `
            <div class="print-header"><h2>Relat√≥rio de Turno</h2><p><strong>${viewMode}</strong> | ${now.toLocaleString()}</p></div>
            <div class="print-stats">${statsHTML}</div>
        `;
        currentData.teams.forEach(team => {
            if (team.members.length === 0) return;
            html += `<div class="print-team"><h3>${team.title} (${team.members.length})</h3><table><thead><tr><th style="width:40%">Nome</th><th style="width:25%">Cargo</th><th style="width:35%">M√°quina</th></tr></thead><tbody>`;
            team.members.forEach(member => {
                const roleObj = currentData.roles.find(r => r.id === member.roleId) || { name: '-', color: '#000' };
                html += `<tr><td><strong>${member.name}</strong></td><td>${roleObj.name}</td><td>${member.area || '-'}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        });
        printArea.innerHTML = html;
        window.print();
    }

    // --- CRUD ---
    function openMemberModal(teamId) { if(isViewingHistory) return; if(liveData.roles.length===0) return alert("Cadastre cargos!"); document.getElementById('modalTitle').innerText="Novo"; document.getElementById('memId').value=""; document.getElementById('memTeamId').value=teamId; document.getElementById('memName').value=""; document.getElementById('memAreaSelect').value=""; populateRoleSelect(); document.getElementById('memberModal').style.display='flex'; document.getElementById('memName').focus(); }
    function editMember(teamId, memberId) { if(isViewingHistory) return; const t=liveData.teams.find(x=>x.id===teamId); const m=t.members.find(x=>x.id===memberId); document.getElementById('modalTitle').innerText="Editar"; document.getElementById('memId').value=memberId; document.getElementById('memTeamId').value=teamId; document.getElementById('memName').value=m.name; document.getElementById('memAreaSelect').value=m.area||""; populateRoleSelect(m.roleId); document.getElementById('memberModal').style.display='flex'; }
    function populateRoleSelect(sid=null) { const s=document.getElementById('memRoleSelect'); s.innerHTML=''; liveData.roles.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.innerText=r.name; if(r.id===sid)o.selected=true; s.appendChild(o); }); }
    function saveMember() { const tid=document.getElementById('memTeamId').value, mid=document.getElementById('memId').value, n=document.getElementById('memName').value, rid=document.getElementById('memRoleSelect').value, a=document.getElementById('memAreaSelect').value; if(!n||!rid||!a) return alert("Preencha tudo!"); const t=liveData.teams.find(x=>x.id===tid); if(mid){ const m=t.members.find(x=>x.id===mid); m.name=n; m.roleId=rid; m.area=a; } else { t.members.push({id:'m'+Date.now(), name:n, roleId:rid, area:a}); } saveData(); closeModal('memberModal'); }
    function deleteMember(tid, mid) { if(isViewingHistory) return; if(confirm("Remover?")) { const t=liveData.teams.find(x=>x.id===tid); t.members=t.members.filter(x=>x.id!==mid); saveData(); } }

    // --- GERAIS ---
    function saveData() { localStorage.setItem('teamDataV9', JSON.stringify(liveData)); localStorage.setItem('teamHistoryV9', JSON.stringify(historyData)); if(!isViewingHistory) renderBoard(liveData); }
    function addTeam() { if(isViewingHistory) return; liveData.teams.push({id:'t'+Date.now(), title:'Nova Equipe', members:[]}); saveData(); }
    function deleteTeam(id) { if(isViewingHistory) return; if(confirm('Excluir equipe?')) { liveData.teams=liveData.teams.filter(t=>t.id!==id); saveData(); } }
    function updateTeamTitle(input, id) { const t=liveData.teams.find(x=>x.id===id); if(t) { t.title=input.value; saveData(); } }
    function closeModal(id) { document.getElementById(id).style.display='none'; }

    // --- HIST√ìRICO ---
    function checkHistory() { const p=document.getElementById('monthPicker'), v=p.value; if(!v) return loadCurrentLive(); if(historyData[v]) { isViewingHistory=true; document.body.classList.add('readonly-mode'); document.getElementById('historyBanner').style.display='block'; document.getElementById('historyBanner').innerText=`HIST√ìRICO: ${v}`; document.getElementById('btnSaveHistory').style.display='none'; document.getElementById('btnBackToLive').style.display='inline-block'; renderBoard(historyData[v]); } else { loadCurrentLive(); p.value=v; } }
    function saveHistorySnapshot() { let v=document.getElementById('monthPicker').value; if(!v) { const n=new Date(); v=`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}`; if(!confirm(`Salvar m√™s atual (${v})?`)) return; document.getElementById('monthPicker').value=v; } historyData[v]=JSON.parse(JSON.stringify(liveData)); saveData(); alert("Salvo!"); }
    function loadCurrentLive() { isViewingHistory=false; document.body.classList.remove('readonly-mode'); document.getElementById('monthPicker').value=""; document.getElementById('historyBanner').style.display='none'; document.getElementById('btnSaveHistory').style.display='inline-block'; document.getElementById('btnBackToLive').style.display='none'; renderBoard(liveData); }

    // --- EXTRAS ---
    function openRoleModal() { if(isViewingHistory)return; renderRolesList(); document.getElementById('roleModal').style.display='flex'; }
    function addNewRole() { const n=document.getElementById('newRoleName').value, c=document.getElementById('newRoleColor').value; if(n){ liveData.roles.push({id:'r'+Date.now(),name:n,color:c}); document.getElementById('newRoleName').value=''; renderRolesList(); saveData(); } }
    function renderRolesList() { const c=document.getElementById('rolesListContainer'); c.innerHTML=''; liveData.roles.forEach(r=>{ const d=document.createElement('div'); d.className='role-list-item'; d.innerHTML=`<span style="color:${r.color};font-weight:bold;">${r.name}</span> <button class="btn-danger" style="font-size:0.7rem;" onclick="delRole('${r.id}')">Excluir</button>`; c.appendChild(d); }); }
    function delRole(id) { if(confirm("Excluir?")) { liveData.roles=liveData.roles.filter(r=>r.id!==id); renderRolesList(); saveData(); } }
    function downloadBackup() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({live:liveData, hist:historyData})); a.download=`backup_v9_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function restoreBackup(input) { const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); if(d.live&&d.hist){ if(confirm("Restaurar?")) { liveData=d.live; historyData=d.hist; saveData(); loadCurrentLive(); } } }catch(x){alert("Erro");} input.value=''; }; if(input.files[0]) r.readAsText(input.files[0]); }

    // --- DRAG ---
    function dragStart(e) { draggedItem=this; setTimeout(()=>this.classList.add('dragging'),0); }
    function dragEnd() { this.classList.remove('dragging'); draggedItem=null; document.querySelectorAll('.member-list').forEach(l=>l.classList.remove('drag-over')); }
    function allowDrop(e) { if(!isViewingHistory) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); } }
    function leaveDrop(e) { e.currentTarget.classList.remove('drag-over'); }
    function drop(e) { if(isViewingHistory) return; e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const tid=e.currentTarget.id, cid=draggedItem.id; let s,m; liveData.teams.forEach(t=>{ const i=t.members.findIndex(x=>x.id===cid); if(i>-1){s=t; m=t.members[i]; t.members.splice(i,1);} }); liveData.teams.find(x=>x.id===tid).members.push(m); saveData(); }
</script>
</body>
</html>